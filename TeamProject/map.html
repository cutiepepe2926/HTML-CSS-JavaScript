<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>지도 페이지</title>

  <!-- tailwindcss import -->
  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="stylesheet" href="./style.css">

</head>
<body class="flex">

  <!-- 좌측 네비(로컬 이미지 아이콘 사용) -->
  <aside class="w-36 bg-[#FFFFFF] border-r flex flex-col justify-between py-4 shadow z-[3000]">
  
    <!-- 활성 상태는 aria-current="page" 로 표시-->
    <!-- 상단 그룹 -->
    <div class="flex flex-col items-center space-y-6 w-full">

      <!-- 홈 화면(메인 지도) -->
      <button class="side-btn w-36 h-24 flex items-center justify-center rounded-lg hover:bg-[#F8C74D]" aria-current="page" data-tab="map" title="지도">
        <img src="./assets/icons/Home.png" alt="지도" class="side-icon w-12 h-12"/>
      </button>
      
      <!-- 추천 피드 & 검색 -->
      <button class="side-btn w-36 h-24 flex items-center justify-center rounded-lg hover:bg-[#F8C74D]" data-tab="search" title="검색">
        <img src="./assets/icons/Search.png" alt="검색" class="side-icon w-12 h-12"/>
      </button>
    
      <!-- 팔로우 피드 -->
      <button class="side-btn w-36 h-24 flex items-center justify-center rounded-lg hover:bg-[#F8C74D]" data-tab="user" title="사용자">
        <img src="./assets/icons/Compass.png" alt="사용자" class="side-icon w-12 h-12"/>
      </button>
    
      <!-- 가게 순위 -->
      <button class="side-btn w-36 h-24 flex items-center justify-center rounded-lg hover:bg-[#F8C74D]" data-tab="crown" title="왕관">
        <img src="./assets/icons/Award.png" alt="추천" class="side-icon w-12 h-12"/>
      </button>
    </div>

    <!-- 하단 그룹 -->
    <div class="flex flex-col items-center space-y-6 w-full">
      
      <!-- 마이페이지 -->
      <button class="side-btn w-36 h-24 flex items-center justify-center hover:bg-[#F8C74D]" data-tab="setting" title="설정">
        <img src="./assets/icons/User.png" alt="설정" class="side-icon w-12 h-12"/>
      </button>
    
      <!-- 로그인/로그아웃 -->
      <button class="side-btn w-36 h-24 flex items-center justify-center hover:bg-[#F8C74D]" data-tab="logout" title="로그아웃">
        <img src="./assets/icons/Logout.png" alt="로그아웃" class="side-icon w-12 h-12"/>
      </button>
    </div>
  </aside>


  <!-- 지도 영역 -->
  <main class="flex-1 relative">
    
    <div id="map"></div>

    
    <!-- 임시 고정 핀 아이콘 -->
    <img src="./assets/icons/colored_filled_pin.png" 
      alt="고정핀" 
      class="absolute top-1/2 left-1/2 w-16 h-16 -translate-x-1/2 -translate-y-1/2 z-[1000] cursor-pointer"/>
       
    <!-- 지도 우측 하단 버튼 그룹 -->
    <div class="absolute bottom-4 right-4 z-[1000] flex items-center space-x-2 bg-none p-2 rounded-lg text-lg">
    
      <!-- 한식 -->
      <button class="food-btn">
        <span class="icon-wrap">
          <img src="./assets/map_icons/koreanfood_icon.png" alt="한식"/>
        </span>
        <span>한식</span>
      </button>

      <!-- 중식 -->
      <button class="food-btn">
        <span class="icon-wrap">
          <img src="./assets/map_icons/chinesefood_icon.png" alt="중식"/>
        </span>
        <span>중식</span>
      </button>

      <!-- 일식 -->
      <button class="food-btn">
        <span class="icon-wrap">
          <img src="./assets/map_icons/japanesefood_icon.png" alt="일식"/>
        </span>
        <span>일식</span>
      </button>

      <!-- 양식 -->
      <button class="food-btn">
        <span class="icon-wrap">
          <img src="./assets/map_icons/westernfood_icon.png" alt="양식"/>
        </span>
        <span>양식</span>
      </button>

      <!-- 분식 -->
      <button class="food-btn">
        <span class="icon-wrap">
          <img src="./assets/map_icons/schoolfood_icon.png" alt="분식"/>
        </span>
        <span>분식</span>
      </button>


      <!-- 확대/축소 -->
      <div class="flex flex-col ml-2">
        
        <!-- 줌인 버튼 -->
        <button id="zoomIn" class="w-12 h-12 flex items-center justify-center bg-gray-100 rounded hover:bg-[#F8C74D] mb-1">+</button>
        
        <!-- 줌 아웃 버튼 -->
        <button id="zoomOut" class="w-12 h-12 flex items-center justify-center bg-gray-100 rounded hover:bg-[#F8C74D] mb-1">-</button>
    
        <!-- 현재 위치 -->
        <button id="currentLocationBtn" class="w-12 h-12 flex items-center justify-center bg-gray-100 rounded hover:bg-[#F8C74D]">
          <img src="./assets/icons/current_location.png" alt="현재 위치" class="w-5 h-5"/>
        </button>
      </div>
    </div>


  
    <!-- 좌측 슬라이드 패널 -->
    <aside id="shopPanel" 
    class="fixed top-0 left-36 w-[33vw] h-full bg-white shadow-lg -translate-x-full transition-transform duration-300 z-[2000] overflow-y-auto">

      <!-- 검색칸으로 변경해야 함 -->
      <div class="p-4 flex justify-between items-center border-b bg-[#FBA62C]">
        <h2 class="text-lg font-bold">강남구 역삼1동</h2>
        
        <!-- 추후에 검색 칸 추가 -->

        <!-- 슬라이드 닫기 버튼 -->
        <button id="panelClose" class="text-xl w-8 h-8 rounded hover:bg-[#845717]">×</button>
      </div>
  
      <!-- JS에서 동적으로 내용을 채울 영역 -->
      <div id="shopContent" class="p-4"></div>
    </aside>

  </main>

  <!-- 리뷰 이미지 클릭 시 원본 크기로 사진 볼 수 있는 Lightbox Modal -->
  <!-- Lightbox Modal -->
  <div id="lightbox" class="fixed inset-0 z-[5000] hidden">
  
    <!-- 반투명 백드롭 -->
    <div id="lbBackdrop" class="absolute inset-0 bg-black/70"></div>

    <!-- 콘텐츠 래퍼 -->
    <div class="relative w-full h-full grid place-items-center p-4">
    
      <!-- 닫기 버튼 -->
      <button id="lbClose" class="absolute top-4 right-4 w-10 h-10 text-2xl
      bg-white/90 hover:bg-white rounded-full grid place-items-center shadow">×
      </button>

      <!-- 원본 이미지 -->
      <img id="lbImage" alt="원본 이미지"
      class="w-[90vw] max-h-[85vh] h-auto object-contain rounded shadow-lg border bg-white"/>
    
      <!-- 캡션 -->
      <div id="lbCaption" class="mt-2 text-white/90 text-sm"></div>
    </div>
  </div>
  

  <!-- 카카오 맵 API 및 라이브러리 추가 -->
  <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=0698fb5cbfd3626afb61d071e360de06&libraries=LIBRARY"></script>
  <script>
    // 지도 생성
    //const map = L.map('map').setView([37.4979, 127.0276], 15);
    var container = document.getElementById('map'); //지도를 담을 영역의 DOM 레퍼런스
    var options = { //지도를 생성할 때 필요한 기본 옵션
      center: new kakao.maps.LatLng(33.450701, 126.570667), //지도의 중심좌표.
      draggable : true,
      level: 3 //지도의 레벨(확대, 축소 정도)
    };
    //window.map = new kakao.maps.Map(container, options); // 전역 노출(버튼 핸들러에서 접근)

    var map = new kakao.maps.Map(container, options); //지도 생성 및 객체 리턴
    

    // 줌인/줌아웃 (Kakao는 setLevel 사용)
    document.getElementById("zoomIn").addEventListener("click", function () {
      var level = map.getLevel();
      if (level > 1) map.setLevel(level - 1);
    });

    document.getElementById("zoomOut").addEventListener("click", function () {
      var level = map.getLevel();
      map.setLevel(level + 1);
    });


    // 지도타입 컨트롤의 지도 또는 스카이뷰 버튼을 클릭하면 호출되어 지도타입을 바꾸는 함수입니다
    function setMapType(maptype) { 
        var roadmapControl = document.getElementById('btnRoadmap');
        var skyviewControl = document.getElementById('btnSkyview'); 
        if (maptype === 'roadmap') {
            map.setMapTypeId(kakao.maps.MapTypeId.ROADMAP);    
            roadmapControl.className = 'selected_btn';
            skyviewControl.className = 'btn';
        } else {
            map.setMapTypeId(kakao.maps.MapTypeId.HYBRID);    
            skyviewControl.className = 'selected_btn';
            roadmapControl.className = 'btn';
        }
    }


    // 현재 위치 버튼 클릭 이벤트
    var currentMarker = null;

    document.getElementById("currentLocationBtn").addEventListener("click", function () {
      if (!navigator.geolocation) {
        alert("이 브라우저에서는 위치 정보가 지원되지 않습니다.");
        return;
      }

      navigator.geolocation.getCurrentPosition(
        function (pos) {
          var lat = pos.coords.latitude;
          var lng = pos.coords.longitude;
          var loc = new kakao.maps.LatLng(lat, lng);

          // 지도 이동
          map.setCenter(loc);
          map.setLevel(3);

          // 기존 마커 제거 후 새로 표시
          if (currentMarker) currentMarker.setMap(null);
          currentMarker = new kakao.maps.Marker({ position: loc });
          currentMarker.setMap(map);

          // (선택) 인포윈도우
          // var iw = new kakao.maps.InfoWindow({ content: '<div style="padding:6px 8px;">현재 위치</div>' });
          // iw.open(map, currentMarker);
        },
        function (err) {
          // 권한 거부, 타임아웃 등
          alert("현재 위치를 가져올 수 없습니다. (" + err.message + ")");
        },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
      );
    });


    // 좌측 사이드 탭 활성화 토글 유틸 (필요한 페이지에서 호출)
    function setActiveTab(tabName) {
      document.querySelectorAll('.side-btn').forEach(btn => {
        if (btn.dataset.tab === tabName) {
          btn.setAttribute('aria-current', 'page');
        } else {
          btn.removeAttribute('aria-current');
        }
      });
    }

    // 이 페이지는 map 페이지이므로 보장
    setActiveTab('map');

    // 안전 바인딩: id가 없거나 pointerEvents가 막혀 있어도 케어
    const pin = document.getElementById('coloredPin') || document.querySelector('img[src$="colored_filled_pin.png"]');
    const panel = document.getElementById('shopPanel');
    const btnClose = document.getElementById('panelClose');
    const shopContent = document.getElementById('shopContent');

    if (pin) {
      // 혹시 모를 잔여 스타일 방지
      pin.style.pointerEvents = 'auto';

      pin.addEventListener('click', () => {
        // 필요시 여기서 실제 가게 데이터 바인딩
        //shopContent.textContent = '프엔카페 - 서울 강남구 / 영업시간 10:00 ~ 21:00';
        shopContent.innerHTML = `
        <!-- 대표 이미지 -->
        <div class="w-full h-96 rounded-lg bg-gray-200 bg-center bg-center bg-contain bg-no-repeat" 
        style="background-image: url('./assets/info_assets/main_pic.png');">
        </div>

        <!-- 가게명 / 카테고리 + 별점 -->
        <div class="flex justify-between items-center mt-4">
          <div>
            <h3 class="text-xl font-semibold">오오기리</h3>
            <p class="text-gray-500 text-sm">일식</p>
          </div>
          <div class="flex items-center space-x-1 text-yellow-500">★★★★★</div>
        </div>

        <!-- 연락처 / 영업시간 -->
        <p class="flex items-center gap-2">
        <img src="./assets/info_assets/tel_icon.png" alt="전화" class="w-5 h-5"/>
        02-1234-5678
        </p>

        <!-- 좋아요 / 리뷰 안내 -->
        <div class="text-sm text-gray-600 space-y-1 border-t pt-2 mt-2">
          <p>♥ 내 팔로워 2명이 좋아요를 눌렀습니다.</p>
          <p>● xxx님이 리뷰를 작성한 식당입니다.</p>
        </div>

        <!-- 리뷰 섹션 -->
        <div class="border-t pt-4 mt-2">
          <div class="flex items-center justify-between mb-2">
            <h4 class="font-semibold">리뷰 112</h4>
            <button class="text-blue-500 text-sm">더보기</button>
          </div>
          
          <div class="grid grid-cols-3 gap-2">
            <div class="h-40 rounded overflow-hidden"><img src="./assets/info_assets/review01.png" alt="리뷰1" class="w-full h-full object-cover"></div>
            <div class="h-40 rounded overflow-hidden"><img src="./assets/info_assets/review02.png" alt="리뷰2" class="w-full h-full object-cover"></div>
            <div class="h-40 rounded overflow-hidden"><img src="./assets/info_assets/review03.png" alt="리뷰3" class="w-full h-full object-cover"></div>
            <div class="h-40 rounded overflow-hidden"><img src="./assets/info_assets/review04.png" alt="리뷰4" class="w-full h-full object-cover"></div>
            <div class="h-40 rounded overflow-hidden"><img src="./assets/info_assets/review05.png" alt="리뷰5" class="w-full h-full object-cover"></div>
          </div>
        </div>
        `;
        
        panel.classList.remove('-translate-x-full');
        panel.classList.add('translate-x-0');
        // 디버그용(필요시 켜기): console.log('[PIN] clicked');
    });
  }

  // 버튼으로 좌측 슬라이드 닫기  
  btnClose?.addEventListener('click', () => {
    panel.classList.remove('translate-x-0');
    panel.classList.add('-translate-x-full');
  });

  // ESC로 좌측 슬라이드 닫기
  window.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      panel.classList.remove('translate-x-0');
      panel.classList.add('-translate-x-full');
    }
  });

  // ===== Lightbox =====
  const lightbox   = document.getElementById('lightbox');
  const lbImg      = document.getElementById('lbImage');
  const lbCaption  = document.getElementById('lbCaption');
  const lbClose    = document.getElementById('lbClose');
  const lbBackdrop = document.getElementById('lbBackdrop');

  function openLightbox(src, caption='') {
    lbImg.src = src;
    lbCaption.textContent = caption;
    lightbox.classList.remove('hidden');
    document.body.style.overflow = 'hidden'; // 스크롤 잠금
  }

  function closeLightbox() {
    lightbox.classList.add('hidden');
    lbImg.src = '';
    lbCaption.textContent = '';
    document.body.style.overflow = ''; // 스크롤 복구
  }

  // 닫기 동작
  lbClose.addEventListener('click', closeLightbox);
  lbBackdrop.addEventListener('click', closeLightbox);
  window.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeLightbox();
  });

  // === 이벤트 위임: shopPanel 내 썸네일 클릭 시 원본 열기 ===
  const panelEl = document.getElementById('shopPanel');
  panelEl.addEventListener('click', (e) => {
    const img = e.target.closest('#shopContent img');
    if (!img) return;

    // data-full 이 있으면 원본 경로로, 없으면 썸네일 경로 사용
    const fullSrc = img.getAttribute('data-full') || img.src;

    // 캡션은 alt 사용
    openLightbox(fullSrc, img.alt || '');
  });

  </script>

</body>
</html>
